<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test de Conexi√≥n - Railway Backend</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="config.js"></script>
  <style>
    body {
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .status-ok { color: #28a745; font-weight: bold; }
    .status-error { color: #dc3545; font-weight: bold; }
    .endpoint-test {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    pre {
      background: #282c34;
      color: #abb2bf;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="text-center mb-4">üß™ Test de Conexi√≥n Backend</h1>
    <p class="text-center mb-4">
      <strong>Backend URL:</strong> <code id="backendUrl"></code>
    </p>

    <div class="alert alert-info">
      <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Esta p√°gina prueba la conectividad con el backend en Railway.
    </div>

    <div id="testResults"></div>

    <div class="text-center mt-4">
      <button class="btn btn-primary btn-lg" onclick="runTests()">üîÑ Ejecutar Tests</button>
      <a href="herramienta.html" class="btn btn-success btn-lg ms-2">‚úÖ Ir a la Herramienta</a>
    </div>
  </div>

  <script>
    // Mostrar URL del backend
    document.getElementById('backendUrl').textContent = API_CONFIG.BASE_URL;

    async function testEndpoint(name, url, method = 'GET', body = null) {
      const startTime = Date.now();
      try {
        const options = {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          }
        };
        if (body) {
          options.body = JSON.stringify(body);
        }

        const response = await fetch(url, options);
        const endTime = Date.now();
        const duration = endTime - startTime;
        
        const data = await response.json();
        
        return {
          success: true,
          status: response.status,
          statusText: response.statusText,
          duration: duration,
          data: data
        };
      } catch (error) {
        const endTime = Date.now();
        const duration = endTime - startTime;
        
        return {
          success: false,
          status: 'ERROR',
          statusText: error.message,
          duration: duration,
          error: error.toString()
        };
      }
    }

    function formatJson(obj) {
      return JSON.stringify(obj, null, 2);
    }

    async function runTests() {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Ejecutando tests...</p></div>';

      const tests = [];

      // Test 1: Health check
      const healthTest = await testEndpoint(
        'Health Check',
        getApiUrl(API_CONFIG.ENDPOINTS.HEALTH),
        'GET'
      );
      tests.push({ name: 'Health Check', url: API_CONFIG.ENDPOINTS.HEALTH, result: healthTest });

      // Test 2: Info de la API
      const infoTest = await testEndpoint(
        'API Info',
        getApiUrl('/'),
        'GET'
      );
      tests.push({ name: 'API Info', url: '/', result: infoTest });

      // Test 3: Login (intentar√° fallar por credenciales inv√°lidas, pero probar√° la conexi√≥n)
      const loginTest = await testEndpoint(
        'Login Test',
        getApiUrl(API_CONFIG.ENDPOINTS.LOGIN),
        'POST',
        { username: 'test', password: 'test' }
      );
      tests.push({ name: 'Login Endpoint', url: API_CONFIG.ENDPOINTS.LOGIN, result: loginTest });

      // Renderizar resultados
      let html = '<h3 class="mt-4">üìä Resultados de los Tests</h3>';
      
      tests.forEach(test => {
        const statusClass = test.result.success ? 'status-ok' : 'status-error';
        const icon = test.result.success ? '‚úÖ' : '‚ùå';
        
        html += `
          <div class="endpoint-test">
            <h5>${icon} ${test.name}</h5>
            <p><strong>Endpoint:</strong> <code>${test.url}</code></p>
            <p><strong>M√©todo:</strong> ${test.url === API_CONFIG.ENDPOINTS.LOGIN ? 'POST' : 'GET'}</p>
            <p><strong>Status:</strong> <span class="${statusClass}">${test.result.status} ${test.result.statusText}</span></p>
            <p><strong>Tiempo de respuesta:</strong> ${test.result.duration}ms</p>
            ${test.result.data ? `
              <details>
                <summary style="cursor: pointer; color: #667eea;">üìÑ Ver respuesta JSON</summary>
                <pre>${formatJson(test.result.data)}</pre>
              </details>
            ` : ''}
            ${test.result.error ? `
              <div class="alert alert-danger mt-2 mb-0">
                <strong>Error:</strong> ${test.result.error}
              </div>
            ` : ''}
          </div>
        `;
      });

      // Resumen
      const successCount = tests.filter(t => t.result.success).length;
      const totalCount = tests.length;
      
      html += `
        <div class="alert ${successCount === totalCount ? 'alert-success' : 'alert-warning'} mt-4">
          <h5>üìà Resumen</h5>
          <p class="mb-0">
            <strong>${successCount} de ${totalCount}</strong> tests pasaron exitosamente.
            ${successCount === totalCount ? 
              '<br>üéâ ¬°El backend est√° funcionando correctamente!' : 
              '<br>‚ö†Ô∏è Algunos endpoints no respondieron correctamente.'}
          </p>
        </div>
      `;

      resultsDiv.innerHTML = html;
    }

    // Ejecutar tests autom√°ticamente al cargar
    window.addEventListener('load', () => {
      setTimeout(runTests, 500);
    });
  </script>
</body>
</html>
